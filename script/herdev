#!/usr/bin/env bash
set -euo pipefail

BLOG_DIR="${HERDEV_DIR:-$HOME/dev/herdev}"
SECTION="${HERDEV_SECTION:-posts}"
EDITOR_CMD="${HERDEV_EDITOR:-}"

die(){ echo "herdev: $*" >&2; exit 1; }

usage() {
  cat <<'EOF'
herdev — créer/publier un post Hugo depuis n'importe où

USAGE:
  herdev [options] <commande> [args]

OPTIONS (globales):
  -C, --dir <path>         Chemin du repo (défaut: $HERDEV_DIR ou ~/dev/herdev)
  -S, --section <name>     Section Hugo (défaut: $HERDEV_SECTION ou "posts")
  -E, --editor <cmd>       Commande d'éditeur (ex: 'code -n') (défaut: $HERDEV_EDITOR)
  -h, --help               Affiche ce help

COMMANDES:
  new "Titre"              Crée un bundle content/<section>/YYYY-MM-DD-slug/index.md et l'ouvre
  serve                    Lance hugo server (drafts inclus) + navigateToChanged
  publish [path]           Met draft=false, build, commit, push (path optionnel)
  cd                       Ouvre le dossier du blog

  display example [path]   Affiche un post en stdout comme exemple
                            - si path absent: prend le index.md le plus récemment modifié sous content/<section>/
                            - path peut être:
                                * un chemin relatif dans le repo (ex: content/posts/..../index.md)
                                * un chemin relatif à content/<section>/...
                                * un chemin absolu

EXEMPLES:
  herdev new "Mon super titre"
  herdev -C ~/Workspace/Perso/Blogs/herdev-blog serve
  herdev publish content/posts/2025-12-16-mon-post/index.md
  herdev display example
  herdev display example content/posts/2025-12-16-mon-post/index.md

ENV:
  HERDEV_DIR, HERDEV_SECTION, HERDEV_EDITOR
EOF
}

need_repo() {
  [[ -d "$BLOG_DIR/.git" ]] || die "repo introuvable: $BLOG_DIR (mets HERDEV_DIR dans ton shell rc)"
  command -v hugo  >/dev/null || die "hugo introuvable (ex: brew install hugo)"
  command -v git   >/dev/null || die "git introuvable"
  command -v iconv >/dev/null || die "iconv introuvable"
}

slugify() {
  local s="$1"

  # 1) lower
  s="$(printf '%s' "$s" | tr '[:upper:]' '[:lower:]')"

  # 2) translit accents -> ascii (UTF-8 -> ASCII)
  #    (TRANSLIT est largement dispo sur macOS)
  s="$(printf '%s' "$s" | iconv -f UTF-8 -t ASCII//TRANSLIT 2>/dev/null || true)"
  [[ -n "$s" ]] || s="$1"

  # 3) non-alnum -> -, trim
  s="$(printf '%s' "$s" | sed -E 's/[^a-z0-9]+/-/g; s/^-+//; s/-+$//; s/-+/-/g')"

  printf '%s\n' "${s:-post}"
}

open_in_editor() {
  local file="$1"
  if [[ -n "$EDITOR_CMD" ]]; then
    bash -lc "$EDITOR_CMD \"$file\""
  else
    open "$file" >/dev/null 2>&1 || true
  fi
}

frontmatter_set_draft_false() {
  local f="$1" tmp
  tmp="$(mktemp "${TMPDIR:-/tmp}/herdev.XXXXXX")"

  awk '
    BEGIN { in_fm=0; delim=""; changed=0 }
    NR==1 && ($0=="---" || $0=="+++") { in_fm=1; delim=$0; print; next }
    in_fm && $0==delim { in_fm=0; print; next }
    in_fm {
      if ($0 ~ /^draft[[:space:]]*:[[:space:]]*true[[:space:]]*$/) { sub(/true/,"false"); changed=1 }
      if ($0 ~ /^draft[[:space:]]*=[[:space:]]*true[[:space:]]*$/) { sub(/true/,"false"); changed=1 }
      print; next
    }
    { print }
    END { if (changed==0) exit 2 }
  ' "$f" >"$tmp" || true

  if [[ ${PIPESTATUS[0]} -eq 2 ]]; then
    rm -f "$tmp"
    return 0
  fi

  mv "$tmp" "$f"
}

frontmatter_get_title() {
  local f="$1"
  awk '
    BEGIN { in_fm=0; delim=""; found=0 }
    NR==1 && ($0=="---" || $0=="+++") { in_fm=1; delim=$0; next }
    in_fm && $0==delim { exit 1 }
    in_fm {
      if (match($0, /^title[[:space:]]*:[[:space:]]*(.*)$/, a) ||
          match($0, /^title[[:space:]]*=[[:space:]]*(.*)$/, a)) {
        t=a[1]
        sub(/^[[:space:]]+/, "", t); sub(/[[:space:]]+$/, "", t)
        if (t ~ /^".*"$/) { sub(/^"/,"",t); sub(/"$/,"",t) }
        else if (t ~ /^\047.*\047$/) { sub(/^\047/,"",t); sub(/\047$/,"",t) } # \047 = '
        print t
        found=1
        exit 0
      }
    }
    END { exit(found?0:1) }
  ' "$f" 2>/dev/null || printf '%s\n' "$(basename "$f" .md)"
}

resolve_post_path() {
  local arg="${1:-}"
  local file=""

  if [[ -n "$arg" ]]; then
    if [[ "$arg" = /* ]]; then
      file="$arg"
    else
      if [[ -f "$BLOG_DIR/$arg" ]]; then
        file="$BLOG_DIR/$arg"
      elif [[ -f "$BLOG_DIR/content/$SECTION/$arg" ]]; then
        file="$BLOG_DIR/content/$SECTION/$arg"
      else
        die "post introuvable: $arg"
      fi
    fi
    [[ -f "$file" ]] || die "fichier introuvable: $file"
    echo "$file"
    return 0
  fi

  local root="$BLOG_DIR/content/$SECTION"
  [[ -d "$root" ]] || die "section introuvable: $root"

  file="$(
    find "$root" -type f -name 'index.md' -print0 2>/dev/null \
      | xargs -0 ls -t 2>/dev/null \
      | head -n 1 || true
  )"
  [[ -n "$file" ]] || die "aucun post trouvé sous $root"
  echo "$file"
}

# -----------------------
# Parse options globales
# -----------------------
cmd=""
args=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help) usage; exit 0 ;;
    -C|--dir)
      [[ $# -ge 2 ]] || die "option $1: argument manquant"
      BLOG_DIR="$2"; shift 2 ;;
    -S|--section)
      [[ $# -ge 2 ]] || die "option $1: argument manquant"
      SECTION="$2"; shift 2 ;;
    -E|--editor)
      [[ $# -ge 2 ]] || die "option $1: argument manquant"
      EDITOR_CMD="$2"; shift 2 ;;
    --)
      shift; break ;;
    -*)
      die "option inconnue: $1 (utilise --help)" ;;
    *)
      cmd="$1"; shift
      args=("$@")
      break ;;
  esac
done

[[ -n "$cmd" ]] || { usage; exit 0; }

case "$cmd" in
  help) usage; exit 0 ;;
  new|serve|publish|pub|display|cd) : ;;
  *)
    die "commande inconnue: $cmd (utilise --help)" ;;
esac

case "$cmd" in
  new|serve|publish|pub|display) need_repo ;;
  cd)
    [[ -d "$BLOG_DIR" ]] || die "dossier introuvable: $BLOG_DIR"
    open "$BLOG_DIR"
    exit 0
    ;;
esac

case "$cmd" in
  new)
    [[ ${#args[@]} -ge 1 ]] || die "usage: herdev [options] new \"Titre\""
    title="${args[*]}"
    slug="$(slugify "$title")"
    d="$(date +%Y-%m-%d)"
    rel="content/${SECTION}/${d}-${slug}/index.md"
    hugo -s "$BLOG_DIR" new content "$rel" >/dev/null
    file="$BLOG_DIR/$rel"
    echo "Créé: $file"
    open_in_editor "$file"
    ;;

  serve)
    ( open "http://localhost:1313/" >/dev/null 2>&1 || true ) &
    hugo -s "$BLOG_DIR" server --buildDrafts --navigateToChanged
    ;;

  publish|pub)
    target="${args[0]:-}"
    if [[ -z "${target:-}" ]]; then
      target="$(git -C "$BLOG_DIR" status --porcelain \
        | awk '{print $2}' \
        | grep -E '^content/' \
        | head -n 1 || true)"
    fi
    [[ -n "${target:-}" ]] || die "rien à publier (aucun changement sous content/)"
    file="$BLOG_DIR/$target"
    [[ -f "$file" ]] || die "fichier introuvable: $file"

    frontmatter_set_draft_false "$file"

    # build local (échoue si ça casse)
    hugo -s "$BLOG_DIR" --minify >/dev/null

    # ✅ add uniquement le post ciblé (évite le commit “je prends tout”)
    git -C "$BLOG_DIR" add "$target"

    title="$(frontmatter_get_title "$file")"
    git -C "$BLOG_DIR" commit -m "post: $title" >/dev/null || die "commit impossible (rien à committer ?)"
    git -C "$BLOG_DIR" push
    echo "Publié: $title"
    ;;

  display)
    sub="${args[0]:-}"
    case "$sub" in
      example|exemple)
        file="$(resolve_post_path "${args[1]:-}")"
        cat "$file"
        ;;
      *)
        die "usage: herdev [options] display example [path]"
        ;;
    esac
    ;;
esac
